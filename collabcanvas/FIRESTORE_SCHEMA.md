# Firestore Schema Documentation

## Collections Structure

### `shapes` Collection

Each document represents a single shape on the canvas. Shapes can be rectangles, circles, or lines.

**Document ID:** Auto-generated by Firestore (unique ID)

**Common Fields (All Shapes):**

```typescript
{
  id: string;              // Firestore document ID (auto-generated)
  type: string;            // Shape type: "rectangle" | "circle" | "line"
  x: number;               // X coordinate (canvas position - start point for lines)
  y: number;               // Y coordinate (canvas position - start point for lines)
  color: string;           // Hex color code (e.g., "#646cff")
  createdBy: string;       // User UID from Firebase Auth
  createdAt: Timestamp;    // Firebase server timestamp
  updatedAt: Timestamp;    // Firebase server timestamp (for last modification)
  lockedBy: string | null; // User UID currently manipulating this shape (null if not locked)
  lockedAt: Timestamp | null; // Timestamp when lock was acquired (null if not locked)
}
```

**Type-Specific Fields:**

**Rectangles & Circles:**
```typescript
{
  width: number;           // Shape width in pixels
  height: number;          // Shape height in pixels (for circles, width=height=diameter)
}
```

**Lines:**
```typescript
{
  endX: number;            // End point X coordinate
  endY: number;            // End point Y coordinate
  strokeWidth: number;     // Line thickness in pixels (default: 2)
}
```

**Example Document (Rectangle):**

```json
{
  "id": "rect_abc123",
  "type": "rectangle",
  "x": 150,
  "y": 200,
  "width": 100,
  "height": 80,
  "color": "#646cff",
  "createdBy": "user_uid_here",
  "createdAt": "2024-01-15T10:30:00Z",
  "updatedAt": "2024-01-15T10:35:00Z",
  "lockedBy": null,
  "lockedAt": null
}
```

**Example Document (Circle):**

```json
{
  "id": "circle_xyz789",
  "type": "circle",
  "x": 300,
  "y": 300,
  "width": 100,
  "height": 100,
  "color": "#4ade80",
  "createdBy": "user_uid_here",
  "createdAt": "2024-01-15T10:31:00Z",
  "updatedAt": "2024-01-15T10:31:00Z",
  "lockedBy": null,
  "lockedAt": null
}
```

**Example Document (Line):**

```json
{
  "id": "line_def456",
  "type": "line",
  "x": 100,
  "y": 100,
  "endX": 300,
  "endY": 200,
  "color": "#f59e0b",
  "strokeWidth": 2,
  "createdBy": "user_uid_here",
  "createdAt": "2024-01-15T10:32:00Z",
  "updatedAt": "2024-01-15T10:32:00Z",
  "lockedBy": null,
  "lockedAt": null
}
```

**Example Document (Locked Shape):**

```json
{
  "id": "rect_abc123",
  "type": "rectangle",
  "x": 150,
  "y": 200,
  "width": 100,
  "height": 80,
  "color": "#646cff",
  "createdBy": "user_uid_here",
  "createdAt": "2024-01-15T10:30:00Z",
  "updatedAt": "2024-01-15T10:35:00Z",
  "lockedBy": "another_user_uid",
  "lockedAt": "2024-01-15T10:36:00Z"
}
```

## Shape Type Details

### Line Shapes

Lines are represented differently from rectangles and circles:

**Coordinate System:**
- `x, y` = Start point of the line
- `endX, endY` = End point of the line
- No `width` or `height` fields (lines use endpoints instead)

**Line Properties:**
- `strokeWidth` = Thickness of the line (default: 2px)
- Hit detection area is 20px wide for easy clicking

**Calculations:**
```javascript
// Line length
const length = Math.sqrt(
  Math.pow(endX - x, 2) + Math.pow(endY - y, 2)
);

// Line angle (degrees)
const angle = Math.atan2(endY - y, endX - x) * (180 / Math.PI);

// Line midpoint
const midX = (x + endX) / 2;
const midY = (y + endY) / 2;
```

**Dragging Behavior:**
- Lines drag from their center point (midpoint)
- When dragged, both start (x, y) and end (endX, endY) positions are updated
- The line maintains its angle and length during movement

**Locking:**
- Lines use the same locking mechanism as other shapes
- Lock icon displays at the line's midpoint
- Other users see reduced opacity and cannot interact with locked lines

---

## Data Flow

### Creating a Shape

1. User draws shape on canvas (click-and-drag)
2. Shape created locally with temporary ID
3. Shape data sent to Firestore via `addShape()`
4. Firestore assigns document ID and server timestamp
5. Real-time listener receives the new shape
6. Local state updates with Firestore document ID

### Updating a Shape

1. User drags shape to new position
2. Shape is locked via `lockShape()` to prevent other users from manipulating it
3. Local state updates immediately (optimistic update)
4. Position sent to Firestore via `updateShape()`
5. Firestore updates document with new position and updatedAt timestamp
6. When drag ends, shape is unlocked via `unlockShape()`
7. Real-time listener broadcasts updates to other users

### Locking a Shape

1. User starts dragging a shape
2. `lockShape()` is called, setting `lockedBy` to the user's UID and `lockedAt` to current timestamp
3. Other users see a red lock icon on the shape
4. Other users cannot interact with or drag the locked shape
5. When dragging ends, `unlockShape()` is called, setting both fields to null
6. Stale locks (older than 30 seconds) are automatically cleaned up to handle disconnections

### Loading Shapes

1. Component mounts
2. Subscribe to shapes collection via `subscribeToShapes()`
3. Firestore returns all existing shapes
4. Shapes loaded into local state
5. Real-time updates continue via the same subscription

## Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Shapes collection
    match /shapes/{shapeId} {
      // Allow authenticated users to read all shapes
      allow read: if request.auth != null;
      
      // Allow authenticated users to create shapes
      // Ensure createdBy matches the user's UID
      allow create: if request.auth != null 
                    && request.resource.data.createdBy == request.auth.uid;
      
      // Allow users to update any shape (collaborative editing)
      allow update: if request.auth != null;
      
      // Allow users to delete their own shapes only
      allow delete: if request.auth != null 
                    && resource.data.createdBy == request.auth.uid;
    }
  }
}
```

## Performance Considerations

### Indexing

Firestore automatically indexes by:
- `createdAt` - for chronological ordering
- `createdBy` - for filtering by user

### Query Limits

- Initial load: All shapes (no limit for MVP)
- Real-time updates: Continuous via snapshot listener

### Optimization Strategies (Future)

1. **Pagination:** Load shapes in batches for large canvases
2. **Viewport filtering:** Only load shapes visible in current viewport
3. **Debouncing:** Batch rapid position updates during dragging
4. **Offline support:** Use Firestore offline persistence

## Migration Path (Future Features)

### Version 2: Shape Types
Add `type` field: `"rectangle" | "circle" | "line" | "text"`

### Version 3: User Cursors
Add `cursors` collection for real-time cursor positions

### Version 4: Layers
Add `zIndex` field for stacking order

