# Firestore Schema V2 - Multi-Tenant Architecture

**Version**: 2.0.0  
**Date**: October 19, 2025  
**Status**: Design Complete - Ready for Implementation

---

## ðŸŽ¯ Design Goals

1. **Multi-Tenancy**: Each user has isolated data
2. **Unlimited Canvases**: Users can create as many canvases as they want
3. **Sharing**: Canvases can be shared with permissions
4. **Scalability**: Structure supports future features (teams, templates, etc.)
5. **Security**: Firestore rules enforce strict access control

---

## ðŸ“Š Collection Overview

```
firestore/
â”œâ”€â”€ users/                  # User profiles
â”œâ”€â”€ workspaces/             # User workspaces (1 per user initially)
â”œâ”€â”€ canvases/               # Canvas metadata
â”‚   â””â”€â”€ {canvasId}/
â”‚       â””â”€â”€ permissions/    # Subcollection: who can access
â”œâ”€â”€ shapes/                 # Shape data (isolated by canvasId)
â”œâ”€â”€ shareLinks/             # Share link tokens
â””â”€â”€ activityLog/            # Activity tracking (optional for Tier 1)
```

---

## ðŸ“‹ Detailed Schema

### 1. `users` Collection

**Purpose**: Store user profile information

**Document ID**: Firebase Auth UID

**Fields**:
```javascript
{
  uid: string,              // Same as document ID (redundant but useful)
  email: string,            // User email
  displayName: string,      // User display name
  photoURL: string | null,  // Profile picture URL
  emailVerified: boolean,   // Email verification status
  
  // Preferences
  defaultWorkspaceId: string | null,  // Default workspace
  
  // Plan information (for future monetization)
  plan: 'free' | 'pro' | 'team' | 'enterprise',  // Default: 'free'
  planStartedAt: timestamp | null,
  planExpiresAt: timestamp | null,
  
  // Timestamps
  createdAt: timestamp,
  updatedAt: timestamp,
  lastLoginAt: timestamp
}
```

**Example**:
```javascript
{
  uid: "user123",
  email: "john@example.com",
  displayName: "John Doe",
  photoURL: "https://...",
  emailVerified: true,
  defaultWorkspaceId: "workspace456",
  plan: "free",
  planStartedAt: null,
  planExpiresAt: null,
  createdAt: Timestamp,
  updatedAt: Timestamp,
  lastLoginAt: Timestamp
}
```

---

### 2. `workspaces` Collection

**Purpose**: Organize canvases into workspaces (each user has at least one)

**Document ID**: Auto-generated by Firestore

**Fields**:
```javascript
{
  name: string,             // Workspace name (e.g., "My Workspace", "Q4 Projects")
  ownerId: string,          // User ID who owns this workspace
  
  // Organization (for Tier 3 - future)
  orgId: string | null,     // If part of an organization
  
  // Settings
  visibility: 'private',    // Only 'private' for Tier 1
  
  // Metadata
  description: string | null,
  color: string | null,     // For UI display
  icon: string | null,      // Emoji or icon name
  
  // Stats (optional, can compute on client)
  canvasCount: number,      // Total canvases in workspace
  
  // Timestamps
  createdAt: timestamp,
  updatedAt: timestamp
}
```

**Example**:
```javascript
{
  name: "My Workspace",
  ownerId: "user123",
  orgId: null,
  visibility: "private",
  description: "Personal projects and designs",
  color: "#3b82f6",
  icon: "ðŸŽ¨",
  canvasCount: 5,
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

**Indexes Required**:
- Composite: `(ownerId ASC, updatedAt DESC)` - for querying user's workspaces

---

### 3. `canvases` Collection

**Purpose**: Store canvas metadata (not the shapes themselves)

**Document ID**: Auto-generated by Firestore

**Fields**:
```javascript
{
  name: string,             // Canvas name (e.g., "Product Mockup", "Untitled Canvas")
  workspaceId: string,      // Which workspace this belongs to
  ownerId: string,          // User ID who created it
  
  // Organization (for Tier 3 - future)
  orgId: string | null,     // If workspace is part of an org
  
  // Visibility & Sharing
  visibility: 'private' | 'shared' | 'public',  // Default: 'private'
  shareToken: string | null,  // Unique token for sharing (e.g., "abc123xyz")
  sharePassword: string | null,  // Hashed password (optional)
  shareExpiresAt: timestamp | null,
  sharePermission: 'view' | 'edit',  // Default permission for share link
  
  // Metadata
  description: string | null,
  tags: string[],           // For search/organization
  category: string | null,  // For templates (Tier 3)
  
  // Thumbnail
  thumbnailUrl: string | null,
  thumbnailGeneratedAt: timestamp | null,
  
  // Stats
  shapeCount: number,       // Total shapes (optional)
  viewCount: number,        // How many times viewed (optional)
  forkCount: number,        // How many times duplicated (optional)
  
  // Soft Delete
  deletedAt: timestamp | null,  // If soft deleted (moved to trash)
  
  // State
  isStarred: boolean,       // User-specific (consider moving to subcollection)
  
  // Timestamps
  createdAt: timestamp,
  updatedAt: timestamp,
  lastEditedAt: timestamp,
  lastEditedBy: string      // User ID
}
```

**Example**:
```javascript
{
  name: "Product Mockup",
  workspaceId: "workspace456",
  ownerId: "user123",
  orgId: null,
  visibility: "shared",
  shareToken: "abc123xyz",
  sharePassword: null,
  shareExpiresAt: null,
  sharePermission: "view",
  description: "Mobile app product page redesign",
  tags: ["mobile", "product", "ui"],
  category: null,
  thumbnailUrl: "https://storage.googleapis.com/.../thumb.jpg",
  thumbnailGeneratedAt: Timestamp,
  shapeCount: 42,
  viewCount: 15,
  forkCount: 2,
  deletedAt: null,
  isStarred: true,
  createdAt: Timestamp,
  updatedAt: Timestamp,
  lastEditedAt: Timestamp,
  lastEditedBy: "user123"
}
```

**Indexes Required**:
- Composite: `(workspaceId ASC, deletedAt ASC, updatedAt DESC)` - for dashboard queries
- Composite: `(ownerId ASC, deletedAt ASC, updatedAt DESC)` - for user's canvases
- Composite: `(visibility ASC, createdAt DESC)` - for public gallery (Tier 3)
- Single: `shareToken ASC` - for share link lookups

---

### 3a. `canvases/{canvasId}/permissions` Subcollection

**Purpose**: Store who has access to this canvas (besides owner)

**Document ID**: User ID

**Fields**:
```javascript
{
  userId: string,           // User being granted permission
  role: 'viewer' | 'editor',  // Permission level
  grantedBy: string,        // User ID who granted permission
  grantedAt: timestamp,
  expiresAt: timestamp | null
}
```

**Example**:
```javascript
// Document ID: "user456"
{
  userId: "user456",
  role: "editor",
  grantedBy: "user123",
  grantedAt: Timestamp,
  expiresAt: null
}
```

**Note**: The owner always has full access (no permission doc needed)

---

### 4. `shapes` Collection

**Purpose**: Store all shape data (rectangles, circles, lines, text)

**Document ID**: Auto-generated by Firestore

**Fields** (same as current, plus canvasId/workspaceId):
```javascript
{
  // Identification
  canvasId: string,         // ðŸ†• CRITICAL: Which canvas this belongs to
  workspaceId: string,      // ðŸ†• For faster queries
  ownerId: string,          // User who created the canvas (for permissions)
  
  // Shape Type
  type: 'rectangle' | 'circle' | 'line' | 'text',
  
  // Common Properties
  x: number,
  y: number,
  
  // Type-Specific Properties
  // Rectangle/Circle:
  width: number | null,
  height: number | null,
  color: string | null,     // Hex color
  
  // Circle:
  radius: number | null,
  
  // Line:
  points: number[] | null,  // [x1, y1, x2, y2]
  strokeWidth: number | null,
  
  // Text:
  text: string | null,
  fontSize: number | null,
  fontWeight: string | null,  // 'normal' | 'bold'
  textAlign: string | null,   // 'left' | 'center' | 'right'
  
  // Transform
  rotation: number,         // 0-359 degrees
  
  // Layer Management
  zIndex: number,           // Can be fractional (5.5, 10.25, etc.)
  
  // Locking (for multiplayer conflict prevention)
  lockedBy: string | null,  // User ID currently editing
  lockedAt: timestamp | null,
  
  // Timestamps
  createdAt: timestamp,
  createdBy: string,        // User ID
  updatedAt: timestamp,
  updatedBy: string
}
```

**Example**:
```javascript
{
  canvasId: "canvas789",
  workspaceId: "workspace456",
  ownerId: "user123",
  type: "rectangle",
  x: 100,
  y: 200,
  width: 300,
  height: 150,
  color: "#3b82f6",
  radius: null,
  points: null,
  strokeWidth: null,
  text: null,
  fontSize: null,
  fontWeight: null,
  textAlign: null,
  rotation: 0,
  zIndex: 10,
  lockedBy: null,
  lockedAt: null,
  createdAt: Timestamp,
  createdBy: "user123",
  updatedAt: Timestamp,
  updatedBy: "user123"
}
```

**Indexes Required**:
- Composite: `(canvasId ASC, zIndex ASC)` - CRITICAL for canvas queries
- Composite: `(canvasId ASC, updatedAt DESC)` - for recent shapes

---

### 5. `shareLinks` Collection (Optional - Alternative to storing in canvas doc)

**Purpose**: Store share link tokens (alternative to storing in canvas document)

**Document ID**: Share token (e.g., "abc123xyz")

**Fields**:
```javascript
{
  token: string,            // Same as document ID
  canvasId: string,         // Canvas being shared
  createdBy: string,        // User who created link
  
  // Permissions
  permission: 'view' | 'edit',
  password: string | null,  // Hashed password (bcrypt)
  
  // Expiration
  expiresAt: timestamp | null,
  
  // Stats
  viewCount: number,
  lastAccessedAt: timestamp | null,
  lastAccessedBy: string | null,
  
  // Timestamps
  createdAt: timestamp
}
```

**Example**:
```javascript
// Document ID: "abc123xyz"
{
  token: "abc123xyz",
  canvasId: "canvas789",
  createdBy: "user123",
  permission: "view",
  password: null,
  expiresAt: null,
  viewCount: 15,
  lastAccessedAt: Timestamp,
  lastAccessedBy: "user456",
  createdAt: Timestamp
}
```

**Note**: For Tier 1, we can store shareToken directly in canvas document. This collection is for Tier 2 (better analytics).

---

### 6. `activityLog` Collection (Optional for Tier 1)

**Purpose**: Track canvas activities for audit trail

**Document ID**: Auto-generated

**Fields**:
```javascript
{
  canvasId: string,
  workspaceId: string,
  userId: string,
  action: string,           // 'created', 'renamed', 'shared', 'deleted', etc.
  details: object,          // Action-specific details
  timestamp: timestamp
}
```

**Example**:
```javascript
{
  canvasId: "canvas789",
  workspaceId: "workspace456",
  userId: "user123",
  action: "canvas_shared",
  details: {
    sharedWith: "user456",
    permission: "editor"
  },
  timestamp: Timestamp
}
```

**Indexes Required**:
- Composite: `(canvasId ASC, timestamp DESC)` - for canvas activity feed

---

## ðŸ”’ Firestore Security Rules

### Key Principles

1. **Users can only access their own data**
2. **Canvas owner has full control**
3. **Shared canvases respect permissions**
4. **Public canvases are read-only (Tier 3)**

### Rules Structure

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(ownerId) {
      return isAuthenticated() && request.auth.uid == ownerId;
    }
    
    function canReadCanvas(canvasId) {
      let canvas = get(/databases/$(database)/documents/canvases/$(canvasId)).data;
      return isOwner(canvas.ownerId)
        || canvas.visibility == 'public'
        || exists(/databases/$(database)/documents/canvases/$(canvasId)/permissions/$(request.auth.uid));
    }
    
    function canEditCanvas(canvasId) {
      let canvas = get(/databases/$(database)/documents/canvases/$(canvasId)).data;
      if (isOwner(canvas.ownerId)) return true;
      
      let permission = get(/databases/$(database)/documents/canvases/$(canvasId)/permissions/$(request.auth.uid)).data;
      return permission.role == 'editor';
    }
    
    // Users Collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // Workspaces Collection
    match /workspaces/{workspaceId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.ownerId)
        // Future: || isMemberOfOrg(resource.data.orgId)
      );
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isOwner(resource.data.ownerId);
    }
    
    // Canvases Collection
    match /canvases/{canvasId} {
      allow read: if isAuthenticated() && canReadCanvas(canvasId);
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthenticated() && canEditCanvas(canvasId);
      allow delete: if isOwner(resource.data.ownerId);
      
      // Permissions Subcollection
      match /permissions/{userId} {
        allow read: if isAuthenticated() && (
          isOwner(get(/databases/$(database)/documents/canvases/$(canvasId)).data.ownerId)
          || request.auth.uid == userId
        );
        allow write: if isOwner(get(/databases/$(database)/documents/canvases/$(canvasId)).data.ownerId);
      }
    }
    
    // Shapes Collection
    match /shapes/{shapeId} {
      allow read: if isAuthenticated() && canReadCanvas(resource.data.canvasId);
      allow write: if isAuthenticated() && canEditCanvas(resource.data.canvasId);
    }
    
    // Share Links Collection (if using separate collection)
    match /shareLinks/{token} {
      allow read: if true;  // Anyone can validate a share link
      allow write: if isAuthenticated() && request.auth.uid == request.resource.data.createdBy;
    }
    
    // Activity Log (read-only for non-owners)
    match /activityLog/{logId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.userId
        || canReadCanvas(resource.data.canvasId)
      );
      allow write: if false;  // Only written by server/client with admin
    }
  }
}
```

---

## ðŸ”„ Migration Strategy (V1 â†’ V2)

### Current Structure (V1)
```
shapes/
  {shapeId}/
    canvasId: "global-canvas-v1"
    type, x, y, width, height, color, ...
```

### Migration Steps

1. **Backup Current Data**
   ```bash
   # Export current Firestore data
   gcloud firestore export gs://backup-bucket/backup-$(date +%Y%m%d)
   ```

2. **For Each User**:
   - Create default workspace: "My Workspace"
   - Create default canvas: "Untitled Canvas"
   - Assign all their shapes to new canvas

3. **Update Shapes**:
   - Add `workspaceId` field
   - Update `canvasId` from "global-canvas-v1" to new canvas ID

4. **Verify**:
   - Check all users have workspace
   - Check all canvases have owner
   - Check all shapes have canvasId/workspaceId
   - Run test queries

5. **Deploy**:
   - Update Firestore rules
   - Deploy new frontend code
   - Monitor for errors

**Script**: `scripts/migrate-to-v2.js` (to be created)

---

## ðŸ“Š Query Patterns

### Common Queries

**1. Get User's Workspaces**
```javascript
const workspaces = await getDocs(
  query(
    collection(db, 'workspaces'),
    where('ownerId', '==', userId),
    orderBy('updatedAt', 'desc')
  )
);
```

**2. Get Canvases in Workspace**
```javascript
const canvases = await getDocs(
  query(
    collection(db, 'canvases'),
    where('workspaceId', '==', workspaceId),
    where('deletedAt', '==', null),
    orderBy('updatedAt', 'desc')
  )
);
```

**3. Get Shapes in Canvas**
```javascript
const shapes = await getDocs(
  query(
    collection(db, 'shapes'),
    where('canvasId', '==', canvasId),
    orderBy('zIndex', 'asc')
  )
);
```

**4. Get Canvas by Share Token**
```javascript
const canvas = await getDocs(
  query(
    collection(db, 'canvases'),
    where('shareToken', '==', token),
    limit(1)
  )
);
```

---

## ðŸŽ¯ Performance Considerations

### Indexes

All indexes listed above are CRITICAL. Without them, queries will fail.

Create indexes via Firebase Console or `firestore.indexes.json`:

```json
{
  "indexes": [
    {
      "collectionGroup": "workspaces",
      "queryScope": "COLLECTION",
      "fields": [
        {"fieldPath": "ownerId", "order": "ASCENDING"},
        {"fieldPath": "updatedAt", "order": "DESCENDING"}
      ]
    },
    {
      "collectionGroup": "canvases",
      "queryScope": "COLLECTION",
      "fields": [
        {"fieldPath": "workspaceId", "order": "ASCENDING"},
        {"fieldPath": "deletedAt", "order": "ASCENDING"},
        {"fieldPath": "updatedAt", "order": "DESCENDING"}
      ]
    },
    {
      "collectionGroup": "shapes",
      "queryScope": "COLLECTION",
      "fields": [
        {"fieldPath": "canvasId", "order": "ASCENDING"},
        {"fieldPath": "zIndex", "order": "ASCENDING"}
      ]
    }
  ]
}
```

### Caching Strategy

- Cache workspace list in React state (rarely changes)
- Cache canvas metadata in React Query (5 min)
- Real-time listeners only for active canvas shapes
- Lazy load canvas thumbnails (Intersection Observer)

---

## âœ… Success Metrics

- **Query Performance**: All queries <500ms
- **Real-time Sync**: Shape updates <100ms
- **Scalability**: Supports 10,000+ users, 100,000+ canvases
- **Data Isolation**: Zero cross-contamination between users
- **Security**: All rules enforced, no unauthorized access

---

## ðŸš€ Next Steps

1. âœ… Review this schema
2. â³ Create service files (`workspaces.js`, `canvases.js`)
3. â³ Write migration script
4. â³ Test locally with Firebase Emulator
5. â³ Deploy to staging
6. â³ Run migration on production

---

**Document Status**: âœ… Complete - Ready for Implementation  
**Last Updated**: October 19, 2025  
**Next**: Create service files


