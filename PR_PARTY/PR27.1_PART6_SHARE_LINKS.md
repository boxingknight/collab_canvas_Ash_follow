# PR27.1 Part 6: Share Links Implementation

**Status**: 🚀 IN PROGRESS  
**Estimated Time**: 4 hours  
**Priority**: HIGH - Critical for commercial multi-user workflows

---

## 🎯 Goal

Enable users to share canvases via generated links with permission control (view/edit), making CollabCanvas a true collaborative platform.

---

## ✅ Features to Implement

### Core Features (MUST HAVE)
1. **Generate Share Links**
   - Create unique, shareable URLs (`/share/:linkId`)
   - Store link metadata in Firestore (`shareLinks` collection)
   - Copy link to clipboard functionality

2. **Permission Levels**
   - **Viewer**: Can see canvas, cannot edit
   - **Editor**: Full edit permissions (same as owner)

3. **Share Dialog UI**
   - Button in canvas header to open share dialog
   - Generate link button
   - Copy link button
   - Permission selector (viewer/editor)
   - Active links list with delete option

4. **Access Share Links**
   - Handle `/share/:linkId` route
   - Validate link exists and not expired
   - Check if user authenticated (require login)
   - Grant permissions based on link type
   - Redirect to canvas with access

### Optional Features (NICE TO HAVE - Defer if needed)
- Password protection for links
- Expiration dates for links
- Access count tracking
- Revoke link functionality

---

## 🏗️ Architecture

### Data Model (Already defined in FIRESTORE_SCHEMA_V2.md)

```javascript
shareLinks/{linkId}
- linkId: string (nanoid) - Unique share link ID
- canvasId: string - Canvas being shared
- createdBy: string (userId) - User who created the link
- permission: 'viewer' | 'editor'
- password: string (optional) - Hashed password for access
- expiresAt: timestamp (optional) - When link expires
- createdAt: timestamp
- accessCount: number - Track usage
- isActive: boolean - Can be disabled without deleting
```

### Component Structure

```
ShareButton (in Canvas header)
  ↓
ShareDialog (modal)
  ↓
  - GenerateLinkForm
  - ActiveLinksList
  - CopyLinkButton

ShareLinkAccess (route: /share/:linkId)
  ↓
  - Validate link
  - Check authentication
  - Grant permissions
  - Redirect to canvas
```

---

## 📝 Implementation Plan

### Step 1: Share Links Service (30 min)
**File**: `src/services/shareLinks.js`

Functions:
- `createShareLink(canvasId, permission, userId)` - Generate new link
- `getShareLink(linkId)` - Get link details
- `validateShareLink(linkId)` - Check if valid/not expired
- `deleteShareLink(linkId)` - Remove link
- `getCanvasShareLinks(canvasId)` - Get all links for a canvas
- `grantAccessFromShareLink(linkId, userId)` - Add user to canvas permissions

### Step 2: Share Dialog Component (1 hour)
**Files**: 
- `src/components/Canvas/ShareDialog.jsx`
- `src/components/Canvas/ShareDialog.css`

Features:
- Modal overlay
- Generate link form with permission selector
- Copy link to clipboard
- List of active share links
- Delete link button
- Close button

### Step 3: Share Button in Canvas Header (15 min)
**File**: `src/components/Layout/AppLayout.jsx`

Add:
- Share button next to canvas name
- Opens ShareDialog
- Only visible on canvas pages
- Only visible if user has edit permissions

### Step 4: Share Link Access Route (45 min)
**Files**:
- `src/pages/ShareLinkAccess/ShareLinkAccess.jsx`
- `src/App.jsx` (add route)

Flow:
1. User visits `/share/:linkId`
2. Check if authenticated (if not, redirect to login with return URL)
3. Validate share link exists and is active
4. Check expiration
5. Grant permissions to user in canvas.permissions map
6. Redirect to `/canvas/:canvasId`

### Step 5: Dashboard Share Button (30 min)
**Files**:
- `src/components/Dashboard/CanvasCard.jsx`
- `src/components/Dashboard/Dashboard.css`

Add:
- Share icon button in canvas card actions (hover)
- Opens same ShareDialog component
- Reusable across canvas and dashboard

### Step 6: Firestore Rules Update (15 min)
**File**: `collabcanvas/firestore.rules`

Add rules for `shareLinks` collection:
- Only authenticated users can read their own links
- Only canvas owners can create/delete share links
- Share links readable by anyone (for validation)

### Step 7: Testing (1 hour)
- Create share link (viewer and editor)
- Copy link to clipboard
- Open link in incognito window
- Verify viewer can see but not edit
- Verify editor can edit
- Delete share link
- Test expired link handling

---

## 🎨 UI/UX Design

### Share Button (Canvas Header)
```
[← Dashboard] [🎨 great canvas] [🔗 Share] ........ [User] [Logout]
```

### Share Dialog
```
┌─────────────────────────────────────────┐
│  Share Canvas                      [X]  │
├─────────────────────────────────────────┤
│                                         │
│  Generate Share Link                    │
│                                         │
│  Permission: [Editor ▼]                 │
│                                         │
│  [Generate Link]                        │
│                                         │
│  ─────────────────────────────          │
│                                         │
│  Active Links (2)                       │
│                                         │
│  🔗 Editor link                         │
│     https://app.com/share/abc123       │
│     [Copy] [Delete]                     │
│                                         │
│  🔗 Viewer link                         │
│     https://app.com/share/xyz789       │
│     [Copy] [Delete]                     │
│                                         │
└─────────────────────────────────────────┘
```

### Share Link Access Flow
```
1. User clicks: https://app.com/share/abc123
2. Not logged in? → Redirect to login with returnUrl
3. Logged in? → Validate link
4. Valid? → Add to canvas.permissions → Redirect to canvas
5. Invalid? → Show error page
```

---

## 🔐 Security Considerations

1. **Authentication Required**
   - All share links require login
   - No anonymous access (prevents abuse)

2. **Link Validation**
   - Check link exists
   - Check not expired
   - Check isActive flag

3. **Permission Scoping**
   - Viewer: Read-only access (no edit, no delete)
   - Editor: Full access (create, edit, delete shapes)
   - Owner: Full access + manage share links

4. **Firestore Rules**
   - Only canvas owners can create share links
   - Share links readable for validation
   - Canvas permissions updated only by owner or share link grant

---

## 📊 Success Criteria

- [ ] Can generate share link from canvas
- [ ] Can generate share link from dashboard
- [ ] Can copy link to clipboard
- [ ] Can open share link in new browser
- [ ] Viewer link allows viewing only
- [ ] Editor link allows full editing
- [ ] Can delete share link
- [ ] Multiple users can access same canvas via different links
- [ ] Share links persist after page refresh

---

## 🚀 Implementation Order

1. ✅ Create share links service
2. ✅ Build share dialog component
3. ✅ Add share button to canvas header
4. ✅ Implement share link access route
5. ✅ Add share button to dashboard cards
6. ✅ Update Firestore rules
7. ✅ Test all flows

**Let's start with Step 1: Share Links Service!**

